<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"><!-- í•œê¸€ ê¹¨ì§ ë°©ì§€ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì˜ì–´ ë‹¨ì–´ í•™ìŠµì¥</title>
  <!-- í•œê¸€ ê¸€ë¦¬í”„ ì§€ì› í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --panel:#111a2d; --ink:#e8eefc; --line:#223054;
      --muted:#9db2d8; --accent:#5aa9ff; --good:#1faa6a; --bad:#a83d45;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,'Malgun Gothic',sans-serif}
    .container{max-width:1180px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{margin:0;font-size:22px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--line);background:#0f1728;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#1b2b4e,#132141);border-color:#2d4376}
    .panel{background:linear-gradient(180deg,#111a2d,#0f1728);border:1px solid var(--line);border-radius:14px;padding:14px;margin:14px 0}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:repeat(3,1fr)}
    .g4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:900px){.g2,.g3,.g4{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="number"],textarea,select{width:100%;background:#0d1526;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px;outline:0}
    textarea{min-height:120px}
    button{background:#101a30;border:1px solid #223054;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1b2b4e,#132141);border-color:#2d4376}
    button.good{background:#0f2d22;border-color:#1f8a5b}
    button.bad{background:#2a1618;border-color:#7a1f2a}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1f2a46;padding:8px 10px;text-align:left;vertical-align:middle}
    th{color:#cfe0ff;background:#132141;position:sticky;top:0}
    .nowrap{white-space:nowrap}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #2a3b67;background:#0f1728;color:#d8e7ff;font-size:12px}
    .progress{height:10px;background:#0f1728;border:1px solid var(--line);border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#5aa9ff,#42e2b8)}
    .hint{color:var(--muted);font-size:12px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>ì˜ì–´ ë‹¨ì–´ í•™ìŠµì¥</h1>
    <div class="tabs">
      <button class="tab active" data-tab="teacher">êµì‚¬</button>
      <button class="tab" data-tab="student">í•™ìƒ</button>
      <button class="tab" data-tab="scores">ì„±ì í‘œ</button>
    </div>
  </header>

  <!-- êµì‚¬ -->
  <section id="teacher" class="panel">
    <h3>â‘  ë‹¨ì–´ì¥ ë§Œë“¤ê¸° / ë¶ˆëŸ¬ì˜¤ê¸°</h3>
    <div class="grid g2">
      <div>
        <label>ë¶™ì—¬ë„£ê¸°(í•œ ì¤„ì— "ì˜ë‹¨ì–´,ëœ»,ë ˆë²¨(A1~C2),í’ˆì‚¬")</label>
        <textarea id="bulk" placeholder="altitude,ê³ ë„,B2,noun
negotiate,í˜‘ìƒí•˜ë‹¤,B2,verb
reliable,ì‹ ë¢°í•  ìˆ˜ ìˆëŠ”,B1,adjective
regularly,ê·œì¹™ì ìœ¼ë¡œ,B1,adverb"></textarea>
        <div class="flex" style="margin-top:8px">
          <button id="parseBulk" class="primary">ë¶™ì—¬ë„£ê¸° ì¶”ê°€</button>
          <input id="fileCsv" type="file" accept=".csv" style="display:none">
          <button id="importCsv">CSV ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="exportCsv">CSV ì €ì¥</button>
          <button id="clearBank" class="bad">ë‹¨ì–´ì¥ ì „ì²´ ì‚­ì œ</button>
        </div>
        <p class="badge" style="margin-top:8px">CSV í—¤ë”: word,meaning,level,pos</p>
      </div>
      <div>
        <label>ë‹¨ì–´ ì¶”ê°€</label>
        <div class="grid g3">
          <div><input id="wWord" type="text" placeholder="word"></div>
          <div><input id="wMean" type="text" placeholder="ëœ»"></div>
          <div><input id="wLevel" type="text" placeholder="ë ˆë²¨(A1~C2)"></div>
        </div>
        <div class="grid g2" style="margin-top:8px">
          <div>
            <select id="wPos">
              <option value="">í’ˆì‚¬</option><option>noun</option><option>verb</option><option>adjective</option>
              <option>adverb</option><option>pronoun</option><option>preposition</option><option>conjunction</option><option>interjection</option><option>phrase</option><option>idiom</option><option>other</option>
            </select>
          </div>
          <div><button id="addRow" class="good">+ ì¶”ê°€</button></div>
        </div>
      </div>
    </div>

    <h3 style="margin-top:18px">â‘¡ ë‹¨ì–´ì¥ í¸ì§‘ / ì„ íƒ</h3>
    <div class="panel" style="padding:0;margin-top:10px">
      <div style="max-height:260px;overflow:auto;border-radius:14px">
        <table>
          <thead>
            <tr>
              <th class="nowrap"><input id="toggleAll" type="checkbox"></th>
              <th>ì˜ë‹¨ì–´</th><th>ëœ»</th><th>ë ˆë²¨</th><th>í’ˆì‚¬</th><th style="text-align:right">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="bankBody"></tbody>
        </table>
      </div>
      <div class="hint" style="padding:8px 12px">ì²´í¬ëœ í•­ëª©ë§Œ í€´ì¦ˆ ì¶œì œ ëŒ€ìƒì…ë‹ˆë‹¤.</div>
    </div>

    <h3 style="margin-top:18px">â‘¢ í€´ì¦ˆ ì„¤ì •</h3>
    <div class="grid g4">
      <div>
        <label>í€´ì¦ˆ ìœ í˜•</label>
        <select id="quizType">
          <option value="mc_w2m">ê°ê´€ì‹: ë‹¨ì–´ â†’ ëœ»</option>
          <option value="mc_m2w">ê°ê´€ì‹: ëœ» â†’ ë‹¨ì–´</option>
          <option value="typing_m2w">íƒ€ì: ëœ» â†’ ë‹¨ì–´</option>
          <option value="typing_w2m">íƒ€ì: ë‹¨ì–´ â†’ ëœ»</option>
        </select>
      </div>
      <div>
        <label>ë³´ê¸° ìˆ˜(ê°ê´€ì‹)</label>
        <input id="choiceCount" type="number" min="2" max="6" value="4">
      </div>
      <div>
        <label>ë¬¸í•­ ìˆ˜</label>
        <input id="questionCount" type="number" min="1" value="10">
      </div>
      <div>
        <label>ì¶œì œ ì˜µì…˜</label>
        <div class="flex">
          <label><input type="checkbox" id="randOrder" checked> ë¬´ì‘ìœ„ ì¶œì œ</label>
          <label><input type="checkbox" id="noDuplicate" checked> ì¤‘ë³µ ì¶œì œ ì—†ìŒ</label>
        </div>
      </div>
    </div>

    <h3 style="margin-top:18px">â‘£ ìˆ˜ì—… ì½”ë“œ & QR</h3>
    <div class="grid g3">
      <div><input id="classCode" type="text" placeholder="ì˜ˆ: ENG1-1"></div>
      <div><input id="deployUrl" type="text" placeholder="ë°°í¬ URL(ë¹„ìš°ë©´ í˜„ì¬ í˜ì´ì§€ ì£¼ì†Œ)"></div>
      <div class="flex"><button id="genQR">QR ìƒì„±</button><button id="saveQrPng">PNG ì €ì¥</button></div>
    </div>
    <div id="qrArea" class="panel" style="min-height:60px"></div>

    <div class="flex" style="justify-content:flex-end">
      <button id="startQuiz" class="primary">í€´ì¦ˆ ì‹œì‘ â†’ í•™ìƒ íƒ­</button>
    </div>
  </section>

  <!-- í•™ìƒ -->
  <section id="student" class="panel" style="display:none">
    <div class="flex">
      <input id="stName" type="text" placeholder="ì´ë¦„">
      <input id="stClass" type="text" placeholder="ìˆ˜ì—… ì½”ë“œ">
      <button id="applyStInfo">ì •ë³´ ì ìš©</button>
      <span class="badge" id="stInfoBadge">ì´ë¦„/ìˆ˜ì—…ì½”ë“œ ë¯¸ì…ë ¥</span>
      <button id="goTeacher">â† êµì‚¬ íƒ­</button>
    </div>

    <div id="quizIntro" style="margin-top:12px">
      <h3>í€´ì¦ˆ ëŒ€ê¸° ì¤‘</h3>
      <p style="color:#9db2d8">êµì‚¬ íƒ­ì—ì„œ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ê³  <b>í€´ì¦ˆ ì‹œì‘</b>ì„ ëˆ„ë¥´ì„¸ìš”.</p>
    </div>

    <div id="quizArea" style="display:none">
      <div class="flex" style="justify-content:space-between">
        <span class="badge" id="qTypeBadge"></span>
        <div style="min-width:220px" class="progress"><div id="bar" class="bar"></div></div>
      </div>

      <div style="margin-top:10px">
        <div id="qCounter" style="color:#9db2d8">1/10</div>
        <h2 id="qTitle" style="margin:6px 0 10px 0">Question</h2>

        <div class="flex" id="hintRow" style="margin-bottom:8px">
          <button id="speakBtn" title="ë°œìŒ ë“£ê¸°(ì˜ë‹¨ì–´)">ğŸ”Š ë°œìŒ</button>
        </div>

        <div id="mcWrap" style="display:none"></div>

        <div id="typingWrap" style="display:none">
          <label id="typingPrompt" style="color:#9db2d8">ëœ»ì„ ë³´ê³  ì •ë‹µ(ì˜ë‹¨ì–´)ì„ ì…ë ¥í•˜ì„¸ìš”</label>
          <input id="typingInput" type="text" placeholder="ì •ë‹µ ì…ë ¥">
          <div class="flex" style="margin-top:8px">
            <button id="typingSubmit" class="primary">ì œì¶œ</button>
            <button id="typingReveal">ì •ë‹µ ë³´ê¸°</button>
          </div>
          <div id="typingFeedback" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="flex" style="justify-content:space-between;margin-top:12px">
        <div id="lastFeedback" style="color:#9db2d8"></div>
        <div class="flex">
          <button id="nextBtn" class="primary" disabled>ë‹¤ìŒ</button>
          <button id="quitBtn">ê·¸ë§Œí•˜ê¸°</button>
        </div>
      </div>
    </div>

    <div id="resultArea" style="display:none">
      <h3>ê²°ê³¼</h3>
      <p><b id="scoreTxt">0/0</b> (<span id="scorePct">0%</span>)</p>
      <div id="breakdown" class="panel" style="max-height:260px;overflow:auto"></div>
      <div class="flex" style="margin-top:8px">
        <button id="retryWrong" class="good">ì˜¤ë‹µë§Œ ì¬ì‹œí—˜</button>
        <button id="reviewWrong" class="primary">ëˆ„ì  ì˜¤ë‹µ í›ˆë ¨</button>
        <button id="restart">ë‹¤ì‹œ í’€ê¸°(ê°™ì€ ì„¤ì •)</button>
      </div>
    </div>
  </section>

  <!-- ì„±ì í‘œ -->
  <section id="scores" class="panel" style="display:none">
    <h3>ì„±ì í‘œ</h3>
    <div style="max-height:360px;overflow:auto;border-radius:14px">
      <table>
        <thead><tr><th>ë‚ ì§œ/ì‹œê°„</th><th>ìˆ˜ì—…ì½”ë“œ</th><th>ì´ë¦„</th><th>ìœ í˜•</th><th>ë¬¸í•­</th><th>ì ìˆ˜</th><th>ì •ë‹µë¥ </th></tr></thead>
        <tbody id="scoreBody"></tbody>
      </table>
    </div>
    <div class="flex" style="margin-top:8px">
      <button id="exportScores">CSV ë‚´ë³´ë‚´ê¸°</button>
      <input id="fileScores" type="file" accept=".csv" style="display:none">
      <button id="importScores">CSV ë¶ˆëŸ¬ì˜¤ê¸°(í•©ì¹˜ê¸°)</button>
      <button id="clearScores" class="bad">ì„±ì  ì´ˆê¸°í™”</button>
    </div>
  </section>
</div>

<!-- QR ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
(() => {
  // ===== ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ =====
  const KEY_BANK='vocab_bank_v5';         // ë‹¨ì–´ì¥
  const KEY_SCORES='vocab_scores_v5';     // ì„±ì í‘œ
  const KEY_QUIZ='vocab_current_quiz_v5'; // ì§„í–‰ì¤‘ í€´ì¦ˆ
  const KEY_CLASS='vocab_class_v5';       // ìˆ˜ì—…ì½”ë“œ ê¸°ë³¸ê°’

  // ===== ì—˜ë¦¬ë¨¼íŠ¸ =====
  const tabs=document.querySelectorAll('.tab');
  const secTeacher=$('#teacher'), secStudent=$('#student'), secScores=$('#scores');

  const bulk=$('#bulk'), parseBulk=$('#parseBulk'), fileCsv=$('#fileCsv'), importCsv=$('#importCsv'),
        exportCsv=$('#exportCsv'), clearBank=$('#clearBank'), addRow=$('#addRow'),
        wWord=$('#wWord'), wMean=$('#wMean'), wLevel=$('#wLevel'), wPos=$('#wPos'),
        bankBody=$('#bankBody'), toggleAll=$('#toggleAll');

  const quizType=$('#quizType'), choiceCount=$('#choiceCount'), questionCount=$('#questionCount'),
        randOrder=$('#randOrder'), noDuplicate=$('#noDuplicate');

  const classCode=$('#classCode'), deployUrl=$('#deployUrl'), genQR=$('#genQR'),
        qrArea=$('#qrArea'), saveQrPng=$('#saveQrPng');

  const stName=$('#stName'), stClass=$('#stClass'), applyStInfo=$('#applyStInfo'), stInfoBadge=$('#stInfoBadge'), goTeacher=$('#goTeacher');

  const quizIntro=$('#quizIntro'), quizArea=$('#quizArea'), qTypeBadge=$('#qTypeBadge'),
        bar=$('#bar'), qCounter=$('#qCounter'), qTitle=$('#qTitle'),
        speakBtn=$('#speakBtn'),
        mcWrap=$('#mcWrap'), typingWrap=$('#typingWrap'),
        typingPrompt=$('#typingPrompt'), typingInput=$('#typingInput'), typingSubmit=$('#typingSubmit'), typingReveal=$('#typingReveal'),
        typingFeedback=$('#typingFeedback'),
        lastFeedback=$('#lastFeedback'), nextBtn=$('#nextBtn'), quitBtn=$('#quitBtn'),
        resultArea=$('#resultArea'), scoreTxt=$('#scoreTxt'), scorePct=$('#scorePct'), breakdown=$('#breakdown'),
        retryWrong=$('#retryWrong'), reviewWrong=$('#reviewWrong'), restart=$('#restart'),
        startQuiz=$('#startQuiz');

  const scoreBody=$('#scoreBody'), exportScores=$('#exportScores'), importScores=$('#importScores'), fileScores=$('#fileScores'), clearScores=$('#clearScores');

  // ===== ìƒíƒœ =====
  let wordBank = loadBank();
  let selectedIds = new Set();
  let currentQuiz = null;

  // ===== ìœ í‹¸ =====
  function $(s){return document.querySelector(s)}
  function $$(s){return Array.from(document.querySelectorAll(s))}
  function shuffle(a){const arr=[...a];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
  function uniqBy(arr, keyFn){const seen=new Set();const out=[];for(const x of arr){const k=keyFn(x);if(!seen.has(k)){seen.add(k);out.push(x)}}return out}
  function csvEscape(v){const s=String(v??'').replace(/"/g,'""');return /[",\n]/.test(s)?`"${s}"`:s}
  function eqLoose(a,b){return (a||'').toLowerCase().replace(/\s+/g,' ').trim()===(b||'').toLowerCase().replace(/\s+/g,' ').trim()}

  // ===== ë‹¨ì–´ì¥ ë¡œë“œ/ì„¸ì´ë¸Œ =====
  function saveBank(){ localStorage.setItem(KEY_BANK, JSON.stringify(wordBank)); }
  function loadBank(){
    const s=localStorage.getItem(KEY_BANK);
    if(s){ try{return JSON.parse(s)}catch(e){} }
    return [
      {word:'altitude', mean:'ê³ ë„', level:'B2', pos:'noun'},
      {word:'negotiate', mean:'í˜‘ìƒí•˜ë‹¤', level:'B2', pos:'verb'},
      {word:'reliable', mean:'ì‹ ë¢°í•  ìˆ˜ ìˆëŠ”', level:'B1', pos:'adjective'},
      {word:'regularly', mean:'ê·œì¹™ì ìœ¼ë¡œ', level:'B1', pos:'adverb'}
    ];
  }

  // ===== ë‹¨ì–´ì¥ í…Œì´ë¸” ë Œë”ë§ =====
  function renderBank(){
    bankBody.innerHTML='';
    wordBank.forEach((row,i)=>{
      const tr=document.createElement('tr');
      const checked=selectedIds.has(i);
      tr.innerHTML=`
        <td class="nowrap"><input data-i="${i}" class="sel" type="checkbox" ${checked?'checked':''}></td>
        <td><input data-i="${i}" data-k="word" type="text" value="${row.word||''}"></td>
        <td><input data-i="${i}" data-k="mean" type="text" value="${row.mean||''}"></td>
        <td><input data-i="${i}" data-k="level" type="text" value="${row.level||''}" placeholder="A1~C2"></td>
        <td>
          <select data-i="${i}" data-k="pos">
            ${['','noun','verb','adjective','adverb','pronoun','preposition','conjunction','interjection','phrase','idiom','other'].map(p=>`<option ${p===(row.pos||'')?'selected':''}>${p}</option>`).join('')}
          </select>
        </td>
        <td style="text-align:right"><button data-i="${i}" class="del bad">ì‚­ì œ</button></td>`;
      bankBody.appendChild(tr);
    });

    bankBody.querySelectorAll('input.sel').forEach(chk=>{
      chk.addEventListener('change', e=>{
        const i=Number(e.target.getAttribute('data-i'));
        if(e.target.checked) selectedIds.add(i); else selectedIds.delete(i);
        toggleAll.checked = wordBank.length>0 && wordBank.every((_,i)=>selectedIds.has(i));
      });
    });
    bankBody.querySelectorAll('input[data-k], select[data-k]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i=Number(e.target.getAttribute('data-i'));
        const k=e.target.getAttribute('data-k');
        wordBank[i][k]=e.target.value;
        saveBank();
      });
    });
    bankBody.querySelectorAll('button.del').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const i=Number(e.target.getAttribute('data-i'));
        wordBank.splice(i,1);
        const newSel=new Set();
        [...selectedIds].forEach(idx=>{ if(idx<i) newSel.add(idx); else if(idx>i) newSel.add(idx-1); });
        selectedIds=newSel; saveBank(); renderBank();
      });
    });

    toggleAll.checked = wordBank.length>0 && wordBank.every((_,i)=>selectedIds.has(i));
  }
  renderBank();

  toggleAll.addEventListener('change', ()=>{
    if(toggleAll.checked){ selectedIds=new Set(wordBank.map((_,i)=>i)); }
    else{ selectedIds.clear(); }
    renderBank();
  });

  parseBulk.addEventListener('click', ()=>{
    const lines=(bulk.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    let added=0;
    for(const line of lines){
      const cols=line.split(',').map(x=>x.trim());
      if(cols.length>=4){
        const [w,m,level,pos] = [cols[0],cols[1],cols[2],cols[3]];
        if(w && m){ wordBank.push({word:w, mean:m, level:level||'', pos:pos||''}); added++; }
      }
    }
    saveBank(); renderBank(); alert(`${added}ê°œ ì¶”ê°€ë¨`);
  });

  addRow.addEventListener('click', ()=>{
    const w=(wWord.value||'').trim(); const m=(wMean.value||'').trim();
    if(!w||!m){ alert('ì˜ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    wordBank.push({word:w, mean:m, level:(wLevel.value||'').trim(), pos:(wPos.value||'').trim()});
    wWord.value=wMean.value=wLevel.value=''; wPos.value='';
    saveBank(); renderBank();
  });

  clearBank.addEventListener('click', ()=>{
    if(!confirm('ë‹¨ì–´ì¥ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
    wordBank=[]; selectedIds.clear(); saveBank(); renderBank();
  });

  // ===== CSV íŒŒì„œ(ë”°ì˜´í‘œ ì•ˆì •í™”) =====
  function parseCSV(text){
    const rows=[]; let cur=[], field='', inQ=false;
    for(let i=0;i<text.length;i++){
      const c=text[i];
      if(inQ){
        if(c=='"' && text[i+1]=='"'){field+='"';i++;}
        else if(c=='"'){inQ=false;}
        else field+=c;
      }else{
        if(c==','){cur.push(field);field='';}
        else if(c=='"'){inQ=true;}
        else if(c=='\n'){cur.push(field);rows.push(cur);cur=[];field='';}
        else field+=c;
      }
    }
    if(field.length||cur.length){cur.push(field);rows.push(cur);}
    return rows;
  }

  importCsv.addEventListener('click', ()=> fileCsv.click());
  fileCsv.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{
      const rows=parseCSV(reader.result); if(rows.length===0) return;
      // í—¤ë” ì°¾ê¸°
      const header=rows.shift().map(h=>h.trim().toLowerCase());
      const idx={word:header.indexOf('word'), mean:header.indexOf('meaning'), level:header.indexOf('level'), pos:header.indexOf('pos')};
      let added=0;
      for(const r of rows){
        const w = idx.word>=0 ? r[idx.word] : r[0];
        const m = idx.mean>=0 ? r[idx.mean] : r[1];
        const lv= idx.level>=0? r[idx.level]: r[2]||'';
        const p = idx.pos>=0  ? r[idx.pos]  : r[3]||'';
        if((w||'').trim() && (m||'').trim()){
          wordBank.push({word:(w||'').trim(), mean:(m||'').trim(), level:(lv||'').trim(), pos:(p||'').trim()});
          added++;
        }
      }
      saveBank(); renderBank(); alert(`CSVì—ì„œ ${added}ê°œ ì¶”ê°€`);
    };
    reader.readAsText(f,'utf-8');
    e.target.value='';
  });

  exportCsv.addEventListener('click', ()=>{
    const rows=[['word','meaning','level','pos'], ...wordBank.map(r=>[r.word||'', r.mean||'', r.level||'', r.pos||''])];
    const csv = rows.map(r=>r.map(csvEscape).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='wordbank.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // ===== QR ìƒì„± =====
  function computeBaseUrl(){
    const inp=deployUrl?.value.trim(); let base= inp || window.location.href;
    try{
      const u=new URL(base, window.location.href); u.hash=''; u.search='';
      if(u.pathname.endsWith('/index.html')) u.pathname=u.pathname.replace(/\/index\.html$/,'/');
      base=u.toString();
    }catch(e){}
    return base;
  }
  let qrObj=null;
  function buildJoinUrl(code){
    const base=computeBaseUrl();
    const u=new URL(base);
    if(code) u.searchParams.set('class', code);
    u.hash='student';
    return u.toString();
  }
  function renderQR(url){
    qrArea.innerHTML='';
    const canvas=document.createElement('canvas'); qrArea.appendChild(canvas);
    qrObj=new QRious({element:canvas,value:url,size:192,level:'H'});
    const p=document.createElement('p'); p.className='hint'; p.style.wordBreak='break-all'; p.textContent=url; qrArea.appendChild(p);
  }
  genQR.addEventListener('click', ()=>{
    const code=(classCode.value||'').trim();
    if(!code) { alert('ìˆ˜ì—… ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    renderQR(buildJoinUrl(code));
    localStorage.setItem(KEY_CLASS, code);
  });
  saveQrPng.addEventListener('click', ()=>{
    if(!qrObj){ alert('ë¨¼ì € QRì„ ìƒì„±í•˜ì„¸ìš”.'); return; }
    const a=document.createElement('a');
    a.href=qrObj.toDataURL('image/png'); a.download='class-qr.png'; a.click();
  });

  // ===== í•™ìƒ ì •ë³´ =====
  applyStInfo.addEventListener('click', updateStInfoBadge);
  function updateStInfoBadge(){
    const n=(stName.value||'').trim(); const c=(stClass.value||'').trim();
    stInfoBadge.textContent = (n && c) ? `ì´ë¦„: ${n} Â· ìˆ˜ì—…ì½”ë“œ: ${c}` : 'ì´ë¦„/ìˆ˜ì—…ì½”ë“œ ë¯¸ì…ë ¥';
  }
  goTeacher.addEventListener('click', ()=> activate('teacher'));

  // URL íŒŒë¼ë¯¸í„°ë¡œ ìˆ˜ì—…ì½”ë“œ ë°°í¬
  window.addEventListener('load', ()=>{
    const url=new URL(window.location.href);
    const cls=url.searchParams.get('class') || localStorage.getItem(KEY_CLASS) || '';
    if(cls){ classCode.value=cls; stClass.value=cls; updateStInfoBadge(); }
    if(url.hash.replace('#','')==='student'){ activate('student'); }
  });

  // ===== í€´ì¦ˆ ìƒì„± =====
  function readSelectedWords(){
    const selected = [...selectedIds].map(i=>wordBank[i]).filter(r=>r && r.word && r.mean);
    return selected;
  }

  function makeQuizPool(){
    let pool = readSelectedWords();
    if(pool.length===0){ alert('ì„ íƒëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return null; }

    // ì¤‘ë³µ ì œê±°(ë‹¨ì–´+ëœ» ì¡°í•© ê¸°ì¤€)
    if(noDuplicate.checked){
      pool = uniqBy(pool, r => `${(r.word||'').toLowerCase()}|${(r.mean||'').toLowerCase()}`);
    }

    // ë¬´ì‘ìœ„ ì…”í”Œ
    if(randOrder.checked) pool = shuffle(pool);

    // ë¬¸í•­ ìˆ˜ ì œí•œ
    const qN = Math.max(1, Math.min(pool.length, Number(questionCount.value||pool.length)));
    return pool.slice(0,qN);
  }

  function buildChoices(item, pool, choiceN, dir){
    const correct = (dir==='w2m') ? item.mean : item.word;
    const key     = (dir==='w2m') ? (r)=>r.mean : (r)=>r.word;
    const others = pool.filter(r => key(r).toLowerCase() !== (correct||'').toLowerCase());
    const uniqOthers = uniqBy(others, r => (key(r)||'').toLowerCase());
    const picks = shuffle(uniqOthers).slice(0, Math.max(0, choiceN-1)).map(r=>key(r));
    return shuffle([correct, ...picks]).slice(0, choiceN);
  }

  function startQuizNow(){
    const selected = readSelectedWords(); if(selected.length===0){ alert('ì„ íƒëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const type = quizType.value;
    const choiceN = Math.max(2, Math.min(6, Number(choiceCount.value||4)));
    const pool = makeQuizPool(); if(!pool) return;

    const items = pool.map(src=>{
      if(type.startsWith('mc')){
        const dir = (type==='mc_w2m')?'w2m':'m2w';
        const q   = (dir==='w2m') ? src.word : src.mean;
        const a   = (dir==='w2m') ? src.mean : src.word;
        const choices = buildChoices(src, pool, choiceN, dir);
        return { q,a,choices,dir,src };
      }else{
        const dir = (type==='typing_m2w')?'m2w':'w2m';
        const q   = (dir==='m2w') ? src.mean : src.word;
        const a   = (dir==='m2w') ? src.word : src.mean;
        return { q,a,dir,src };
      }
    });

    currentQuiz = { type, items, idx:0, correct:0, wrong:0, answers:[] };
    localStorage.setItem(KEY_QUIZ, JSON.stringify(currentQuiz));
    activate('student'); beginQuiz();
  }
  startQuiz.addEventListener('click', startQuizNow);

  // ===== íƒ­ ì „í™˜ =====
  tabs.forEach(btn=>btn.addEventListener('click', ()=>activate(btn.getAttribute('data-tab'))));
  function activate(name){
    tabs.forEach(b=>b.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
    secTeacher.style.display=(name==='teacher')?'block':'none';
    secStudent.style.display=(name==='student')?'block':'none';
    secScores.style.display=(name==='scores')?'block':'none';
    if(name==='scores') renderScores();
    if(name==='student') beginQuiz();
  }

  // ===== í•™ìƒ í€´ì¦ˆ ë Œë” =====
  function beginQuiz(){
    const saved=localStorage.getItem(KEY_QUIZ);
    if(!saved){ quizIntro.style.display='block'; quizArea.style.display='none'; resultArea.style.display='none'; return; }
    currentQuiz=JSON.parse(saved);
    quizIntro.style.display='none'; resultArea.style.display='none'; quizArea.style.display='block';
    qTypeBadge.textContent = ({mc_w2m:'ê°ê´€ì‹ (ë‹¨ì–´â†’ëœ»)', mc_m2w:'ê°ê´€ì‹ (ëœ»â†’ë‹¨ì–´)', typing_m2w:'íƒ€ì (ëœ»â†’ë‹¨ì–´)', typing_w2m:'íƒ€ì (ë‹¨ì–´â†’ëœ»)'}[currentQuiz.type]||currentQuiz.type);
    renderQuestion();
  }

  function renderQuestion(){
    const qz=currentQuiz; const i=qz.idx; const N=qz.items.length; const item=qz.items[i];
    qCounter.textContent=`${i+1}/${N}`; bar.style.width = `${(i/N)*100}%`;

    // ë°œìŒ ë²„íŠ¼(ì˜ë‹¨ì–´ì¼ ë•Œ ì½ê¸°)
    speakBtn.onclick=()=>{
      const utter = new SpeechSynthesisUtterance();
      utter.lang = 'en-US';
      utter.text = (item.dir==='w2m' || (qz.type==='typing_w2m')) ? item.q : item.a; // í™”ë©´ì— ë³´ì´ëŠ” ì˜ë‹¨ì–´ë¥¼ ìš°ì„ 
      window.speechSynthesis.cancel(); window.speechSynthesis.speak(utter);
    };

    if(qz.type.startsWith('mc')){
      typingWrap.style.display='none'; mcWrap.style.display='block'; mcWrap.innerHTML='';
      qTitle.textContent = item.dir==='w2m' ? `ëœ»ì´ ë¬´ì—‡ì¼ê¹Œìš”?  â€”  ${item.q}` : `ì–´ë–¤ ë‹¨ì–´ì¼ê¹Œìš”?  â€”  ${item.q}`;
      lastFeedback.textContent='';
      item.choices.forEach(choice=>{
        const btn=document.createElement('button'); btn.className='choice'; btn.textContent=choice;
        btn.style.cssText='display:block;width:100%;text-align:left;padding:12px 14px;border-radius:12px;border:1px solid #25355e;background:#0f1728;margin-bottom:8px';
        btn.onclick=()=>{
          if(btn.dataset.locked) return;
          const correct=(choice===item.a);
          btn.style.borderColor = correct ? '#1faa6a' : '#a83d45';
          btn.style.background = correct ? '#0f2d22' : '#2a1618';
          lastFeedback.textContent = correct ? 'ì •ë‹µ!' : `ì˜¤ë‹µâ€¦ ì •ë‹µ: ${item.a}`;
          qz.answers.push({q:item.q,a:item.a,given:choice,ok:correct,dir:item.dir,src:item.src});
          if(correct) qz.correct++; else qz.wrong++;
          qz.items[i].choices.forEach(()=>{}); // noop
          nextBtn.disabled=false;
          $$('#mcWrap .choice').forEach(b=>b.dataset.locked='1');
          localStorage.setItem(KEY_QUIZ, JSON.stringify(qz));
        };
        mcWrap.appendChild(btn);
      });
      nextBtn.disabled=true;
    }else{
      mcWrap.style.display='none'; typingWrap.style.display='block';
      qTitle.textContent = item.dir==='m2w' ? `ëœ»ì„ ë³´ê³  ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”` : `ë‹¨ì–´ë¥¼ ë³´ê³  ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”`;
      typingPrompt.textContent = item.dir==='m2w' ? `ëœ»: ${item.q}` : `ë‹¨ì–´: ${item.q}`;
      typingInput.value=''; typingFeedback.innerHTML=''; lastFeedback.textContent='';
      nextBtn.disabled=true;

      const submit=()=>{
        const v=typingInput.value.trim(); if(!v) return;
        const ok = eqLoose(v, item.a);
        typingFeedback.innerHTML = ok ? '<span class="badge" style="border-color:#1faa6a;background:#0f2d22">ì •ë‹µ!</span>' :
                                        `<span class="badge" style="border-color:#a83d45;background:#2a1618">ì˜¤ë‹µâ€¦ ì •ë‹µ: ${item.a}</span>`;
        currentQuiz.answers.push({q:item.q,a:item.a,given:v,ok,dir:item.dir,src:item.src});
        if(ok) currentQuiz.correct++; else currentQuiz.wrong++;
        nextBtn.disabled=false;
        localStorage.setItem(KEY_QUIZ, JSON.stringify(currentQuiz));
      };
      typingSubmit.onclick=submit; typingInput.onkeydown=(e)=>{ if(e.key==='Enter') submit(); };
      typingReveal.onclick=()=>{ typingFeedback.innerHTML=`<span class="badge">ì •ë‹µ: ${item.a}</span>`; };
    }
  }

  nextBtn.addEventListener('click', ()=>{
    const qz=currentQuiz; const N=qz.items.length;
    if(qz.idx<N-1){ qz.idx++; localStorage.setItem(KEY_QUIZ, JSON.stringify(qz)); renderQuestion(); }
    else{ finishQuiz(); }
  });
  quitBtn.addEventListener('click', finishQuiz);

  function finishQuiz(){
    const qz=currentQuiz;
    quizArea.style.display='none'; resultArea.style.display='block';
    const N=qz.items.length, s=qz.correct, pct=Math.round(100*s/N);
    scoreTxt.textContent=`${s}/${N}`; scorePct.textContent=`${pct}%`;
    bar.style.width='100%';

    const rows = qz.answers.map((r,idx)=>`
      <div style="padding:8px 10px;border:1px solid #223054;border-radius:10px;margin-bottom:6px;background:#0f1728">
        <div style="color:#9db2d8">Q${idx+1} ${r.dir==='w2m'?'ë‹¨ì–´â†’ëœ»':'ëœ»â†’ë‹¨ì–´'} [${r.q}]</div>
        <div>ì •ë‹µ: <b style="color:${r.ok?'#a7f3d0':'#fecaca'}">${r.a}</b> Â· ë‚´ ë‹µ: ${r.given??'-'}</div>
      </div>`).join('');
    breakdown.innerHTML = rows || '<div style="color:#9db2d8">ë‹µì•ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

    saveResult(); // ì„±ì í‘œì— ê¸°ë¡
  }

  // ì˜¤ë‹µë§Œ ì¬ì‹œí—˜
  retryWrong.addEventListener('click', ()=>{
    const qz=currentQuiz;
    const wrong = qz.answers.filter(r=>!r.ok).map(r=>r.src);
    if(wrong.length===0){ alert('ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    setQuizFromPool(wrong);
  });
  // ëˆ„ì  ì˜¤ë‹µ í›ˆë ¨(ê¸°ê¸°ë³„ localStorageì— ëˆ„ì )
  reviewWrong.addEventListener('click', ()=>{
    const list=loadScores(); // ì„±ì í‘œì™€ëŠ” ë³„ê°œë¡œ ëˆ„ì  ì˜¤ë‹µ í’€ì„ êµ¬ì„±í•˜ë ¤ë©´ í™•ì¥ í•„ìš”
    const last= currentQuiz?.answers?.filter(r=>!r.ok).map(r=>r.src) || [];
    if(last.length===0){ alert('ìµœê·¼ ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    setQuizFromPool(last);
  });
  // ê°™ì€ ì„¤ì •ìœ¼ë¡œ ë‹¤ì‹œ
  restart.addEventListener('click', ()=> startQuizNow());

  function setQuizFromPool(pool){
    if(noDuplicate.checked) pool = uniqBy(pool, r => `${(r.word||'').toLowerCase()}|${(r.mean||'').toLowerCase()}`);
    if(randOrder.checked) pool = shuffle(pool);
    const type=quizType.value;
    const choiceN=Math.max(2, Math.min(6, Number(choiceCount.value||4)));
    const qN=Math.max(1, Math.min(pool.length, Number(questionCount.value||pool.length)));
    const sel=pool.slice(0,qN);
    const items = sel.map(src=>{
      if(type.startsWith('mc')){
        const dir = (type==='mc_w2m')?'w2m':'m2w';
        const q   = (dir==='w2m') ? src.word : src.mean;
        const a   = (dir==='w2m') ? src.mean : src.word;
        const choices = buildChoices(src, sel, choiceN, dir);
        return { q,a,choices,dir,src };
      }else{
        const dir=(type==='typing_m2w')?'m2w':'w2m';
        const q=(dir==='m2w')?src.mean:src.word, a=(dir==='m2w')?src.word:src.mean;
        return { q,a,dir,src };
      }
    });
    currentQuiz={type,items,idx:0,correct:0,wrong:0,answers:[]};
    localStorage.setItem(KEY_QUIZ, JSON.stringify(currentQuiz));
    resultArea.style.display='none'; quizArea.style.display='block'; renderQuestion();
  }

  // ===== ì„±ì í‘œ =====
  function loadScores(){ try{ return JSON.parse(localStorage.getItem(KEY_SCORES)||'[]'); }catch(e){ return []; } }
  function saveScores(list){ localStorage.setItem(KEY_SCORES, JSON.stringify(list)); }
  function saveResult(){
    const name=(stName.value||'').trim()||'ë¬´ëª…';
    const klass=(stClass.value||'').trim()||classCode.value||'';
    const qz=currentQuiz; const N=qz.items.length; const s=qz.correct;
    const record={ when:new Date().toISOString(), class:klass, name, type:({mc_w2m:'ê°ê´€ì‹ (ë‹¨ì–´â†’ëœ»)', mc_m2w:'ê°ê´€ì‹ (ëœ»â†’ë‹¨ì–´)', typing_m2w:'íƒ€ì (ëœ»â†’ë‹¨ì–´)', typing_w2m:'íƒ€ì (ë‹¨ì–´â†’ëœ»)'}[qz.type]||qz.type, count:N, score:s, pct:Math.round(100*s/N) };
    const list=loadScores(); list.unshift(record); saveScores(list);
  }
  function renderScores(){
    const list=loadScores();
    scoreBody.innerHTML = list.map(r=>{
      const dt=new Date(r.when);
      const when=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      return `<tr><td>${when}</td><td>${r.class||''}</td><td>${r.name}</td><td>${r.type}</td><td>${r.count}</td><td>${r.score}</td><td>${r.pct}%</td></tr>`;
    }).join('');
  }
  exportScores.addEventListener('click', ()=>{
    const list=loadScores();
    const rows=[['timestamp','class','name','type','count','score','pct'],
                ...list.map(r=>[r.when,r.class||'',r.name,r.type,r.count,r.score,r.pct])];
    const csv = rows.map(r=>r.map(csvEscape).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='scores.csv'; a.click(); URL.revokeObjectURL(url);
  });
  importScores.addEventListener('click', ()=> fileScores.click());
  fileScores.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader(); reader.onload=()=>{
      const rows=parseCSV(reader.result); if(rows.length===0) return;
      const header=rows.shift().map(h=>h.trim().toLowerCase());
      const id=(name)=>header.indexOf(name);
      const list=loadScores(); let added=0;
      for(const r of rows){
        if(r.length<3) continue;
        const rec={
          when:r[id('timestamp')]||r[0],
          class:r[id('class')]||'',
          name:r[id('name')]||'',
          type:r[id('type')]||'',
          count:Number(r[id('count')]||0),
          score:Number(r[id('score')]||0),
          pct:Number(r[id('pct')]||0),
        };
        if(rec.when){ list.push(rec); added++; }
      }
      saveScores(list); renderScores(); alert(`ì„±ì  ${added}ê°œ ë³‘í•©`);
    };
    reader.readAsText(f,'utf-8'); e.target.value='';
  });
  clearScores.addEventListener('click', ()=>{ if(confirm('ì„±ì í‘œë¥¼ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')){ saveScores([]); renderScores(); } });

  // ===== ì´ˆê¸°í™” =====
  tabs[0].classList.add('active'); activate('teacher'); renderScores();

})();
</script>
</body>
</html>
