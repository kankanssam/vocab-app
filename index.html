<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>영어 단어 퀴즈 PLUS</title>
<style>
  :root{
    --bg:#0b1220; --panel:#121a2b; --ink:#e8eefc; --muted:#9db2d8;
    --line:#21325b; --accent:#5aa9ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR','Malgun Gothic',Arial,sans-serif;
    background:radial-gradient(1200px 700px at 20% -10%,#162038 0%,#0b1220 60%), var(--bg);
    color:var(--ink);
  }
  .container{max-width:1180px; margin:24px auto; padding:0 16px}
  header{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px}
  h1{font-size:24px; margin:0}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{border:1px solid var(--line); background:#0f1728; color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer}
  .tab.active{background:linear-gradient(180deg,#1b2b4e 0%, #132141 100%); border-color:#2d4376}
  .pill{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #24406c; background:#132143; color:#d8e7ff; font-size:12px}

  .panel{background:linear-gradient(180deg,#111a2d 0%, #0f1728 100%); border:1px solid var(--line); border-radius:14px; padding:14px; margin:14px 0}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  .g4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:900px){ .g2,.g3,.g4{grid-template-columns:1fr} }

  label{font-size:12px; color:var(--muted)}
  input[type="text"], input[type="number"], textarea, select{
    width:100%; background:#0d1526; border:1px solid var(--line); color:var(--ink); padding:10px 12px; border-radius:10px; outline:none
  }
  textarea{min-height:120px}
  button{background:#101a30; border:1px solid #223054; color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer}
  button.primary{background:linear-gradient(180deg,#1b2b4e 0%, #132141 100%); border-color:#2d4376}
  button.good{background:#0f2d22; border-color:#1f8a5b}
  button.bad{background:#2a1618; border-color:#7a1f2a}
  button:disabled{opacity:.6; cursor:not-allowed}

  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{border-bottom:1px solid #1f2a46; padding:8px 10px; text-align:left}
  th{color:#cfe0ff; font-weight:600}
  td{color:#e6eeff}
  .nowrap{white-space:nowrap}
  .right{text-align:right}

  .q-wrap{display:flex; flex-direction:column; gap:12px}
  .choice{display:block; width:100%; text-align:left; padding:12px 14px; border-radius:12px; border:1px solid #25355e; background:#0f1728; transition:.15s}
  .choice:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .choice.correct{border-color:#1faa6a; background:#0f2d22}
  .choice.wrong{border-color:#a83d45; background:#2a1618}

  .progress{height:10px; background:#0f1728; border:1px solid var(--line); border-radius:99px; overflow:hidden}
  .bar{height:100%; width:0; background:linear-gradient(90deg,#5aa9ff,#42e2b8)}

  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3b67; background:#0f1728; color:#d8e7ff}
  .muted{color:var(--muted); font-size:13px}

  .hint-img{max-width:240px; max-height:160px; border-radius:10px; border:1px solid #223054}
  .blur{filter:blur(8px)}
  .footer{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>영어 단어 퀴즈 PLUS</h1>
    <div class="tabs">
      <button class="tab active" data-tab="teacher">교사</button>
      <button class="tab" data-tab="student">학생</button>
      <button class="tab" data-tab="scores">성적표</button>
    </div>
  </header>

  <div id="status" class="pill">준비 완료</div>

  <section id="teacher" class="panel">
    <h3>① 단어장 만들기 / 불러오기</h3>
    <div class="grid g2">
      <div>
        <label>붙여넣기(한 줄에 "영단어,뜻,레벨(A1~C2),품사")</label>
        <textarea id="bulk" placeholder="altitude,고도,B2,noun
gravity,중력,B1,noun
negotiate,협상하다,B2,verb
reliable,신뢰할 수 있는,B1,adjective"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
          <button id="parseBulk" class="primary">붙여넣기 추가</button>
          <input id="fileCsv" type="file" accept=".csv" style="display:none">
          <button id="importCsv">CSV 불러오기</button>
          <button id="exportCsv">CSV 저장</button>
          <button id="clearBank" class="bad">단어장 전체 삭제</button>
        </div>
      </div>
      <div>
        <label>단어 추가</label>
        <div class="grid g3">
          <div><input id="wWord" type="text" placeholder="word"></div>
          <div><input id="wMean" type="text" placeholder="뜻"></div>
          <div><input id="wLevel" type="text" placeholder="레벨(A1~C2)"></div>
        </div>
        <div class="grid g2" style="margin-top:8px">
          <div>
            <select id="wPos">
              <option value="">품사</option><option>noun</option><option>verb</option><option>adjective</option>
              <option>adverb</option><option>pronoun</option><option>preposition</option><option>conjunction</option><option>interjection</option><option>phrase</option><option>idiom</option><option>other</option>
            </select>
          </div>
          <div><button id="addRow" class="good">+ 추가</button></div>
        </div>
        <p class="muted" style="margin-top:10px">※ 단어장은 브라우저에 저장됩니다(localStorage). 새로고침/종료 후에도 유지됩니다.</p>
      </div>
    </div>

    <h3 style="margin-top:18px">② 단어장 편집 / 선택 (필터 & 일괄선택)</h3>
    <div class="grid g4">
      <div>
        <label>레벨 필터</label>
        <select id="fLevel"><option value="">전체</option><option>A1</option><option>A2</option><option>B1</option><option>B2</option><option>C1</option><option>C2</option></select>
      </div>
      <div>
        <label>품사 필터</label>
        <select id="fPos"><option value="">전체</option><option>noun</option><option>verb</option><option>adjective</option><option>adverb</option><option>pronoun</option><option>preposition</option><option>conjunction</option><option>interjection</option><option>phrase</option><option>idiom</option><option>other</option></select>
      </div>
      <div><label>&nbsp;</label><button id="filterSelect" class="primary">필터에 맞는 단어 모두 선택</button></div>
      <div><label>&nbsp;</label><button id="clearSelect">선택 해제</button></div>
    </div>

    <div class="panel" style="padding:0; margin-top:10px">
      <div style="max-height:260px; overflow:auto; border-radius:14px">
        <table>
          <thead>
            <tr>
              <th class="nowrap"><input id="toggleAll" type="checkbox"></th>
              <th>영단어</th><th>뜻</th><th>레벨</th><th>품사</th><th class="right">작업</th>
            </tr>
          </thead>
          <tbody id="bankBody"></tbody>
        </table>
      </div>
    </div>

    <h3 style="margin-top:18px">③ 퀴즈 설정 · 수업 코드 · QR</h3>
    <div class="grid g3">
      <div>
        <label>퀴즈 유형</label>
        <select id="quizType">
          <option value="mc_w2m">객관식: 단어 → 뜻</option>
          <option value="mc_m2w">객관식: 뜻 → 단어</option>
          <option value="typing_m2w">타자: 뜻 → 단어</option>
          <option value="typing_w2m">타자: 단어 → 뜻</option>
        </select>
      </div>
      <div>
        <label>보기 수(객관식)</label>
        <input id="choiceCount" type="number" min="2" max="6" value="4">
      </div>
      <div>
        <label>문항 수(선택 단어 중)</label>
        <input id="questionCount" type="number" min="1" value="5">
      </div>
    </div>

    <div class="grid g3" style="margin-top:8px">
       <div>
        <label>발음 힌트 허용</label>
        <select id="optSpeak"><option value="off">끄기</option><option value="word">단어만</option><option value="mean">뜻만</option><option value="both">단어/뜻 모두</option></select>
      </div>
     <div>
        <label>수업 코드</label>
        <input id="classCode" type="text" placeholder="예: ENG1-3A">
      </div>
      <div>
        <label>배포 URL (선택)</label>
        <input id="shareUrl" type="text" placeholder="이 HTML을 올린 주소(있다면)">
      </div>
    </div>

    <div class="footer" style="margin-top:10px">
      <div>
        <span class="badge">무작위 출제</span>
        <span class="badge">중복 출제 없음</span>
        <span class="badge">오답 노트 기반 재출제 지원</span>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button id="genQR">QR 생성</button>
        <button id="saveQR">QR PNG 저장</button>
        <button id="startQuiz" class="primary">퀴즈 시작 → 학생 탭</button>
      </div>
    </div>

    <div id="qrPanel" class="panel" style="display:none">
      <h4>수업 참여 QR</h4>
      <canvas id="qrCanvas"></canvas>
      <p class="muted">※ 파일을 웹에 올린 경우에만 다른 기기에서 접속 가능합니다. 로컬 파일일 경우, QR은 <b>수업 코드 공유용</b>으로만 사용하세요.</p>
    </div>
  </section>

  <section id="student" class="panel" style="display:none">
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
      <input id="stName" type="text" placeholder="이름">
      <input id="stClass" type="text" placeholder="수업 코드">
      <button id="applyStInfo">정보 적용</button>
      <span class="badge" id="stInfoBadge">이름/수업코드 미입력</span>
    </div>

    <div id="quizIntro" style="margin-top:12px">
      <h3>퀴즈 대기 중</h3>
      <p class="muted">교사 탭에서 단어를 선택하고 <b>퀴즈 시작</b>을 누르면 자동으로 문제가 생성됩니다.</p>
    </div>

    <div id="quizArea" style="display:none">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
        <div><span class="badge" id="qTypeBadge"></span></div>
        <div style="min-width:200px" class="progress"><div id="bar" class="bar"></div></div>
      </div>

      <div style="margin-top:12px">
        <div class="muted" id="qCounter">1/10</div>
        <h2 id="qTitle" style="margin:6px 0 10px 0">Question</h2>

        <div id="hintRow" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
          <button id="speakBtn" style="display:none">🔊 발음 듣기</button>
        </div>

        <div id="mcWrap" class="q-wrap" style="display:none"></div>

        <div id="typingWrap" style="display:none">
          <label id="typingPrompt" class="muted">뜻을 보고 정답(영단어)을 입력하세요</label>
          <input id="typingInput" type="text" placeholder="정답 입력">
          <div style="display:flex; gap:8px; margin-top:8px">
            <button id="typingSubmit" class="primary">제출</button>
            <button id="typingReveal">정답 보기</button>
          </div>
          <div id="typingFeedback" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="footer" style="margin-top:14px">
        <div id="lastFeedback" class="muted"></div>
        <div style="display:flex; gap:8px">
          <button id="nextBtn" class="primary" disabled>다음</button>
          <button id="quitBtn">그만하기</button>
        </div>
      </div>
    </div>

    <div id="resultArea" style="display:none">
      <h3>결과</h3>
      <p><b id="scoreTxt">0/0</b> (<span id="scorePct">0%</span>)</p>
      <div id="breakdown" class="panel" style="max-height:260px; overflow:auto"></div>
      <div style="display:flex; gap:8px; margin-top:8px; align-items:center; flex-wrap:wrap">
        <button id="retryWrong" class="good">오답만 재시험</button>
        <button id="reviewWrong" class="primary">누적 오답 훈련</button>
        <button id="restart">다시 풀기(같은 설정)</button>
        <button id="newSet">새로운 문제 세트 시작</button>
      </div>
    </div>
  </section>

  <section id="scores" class="panel" style="display:none">
    <h3>성적표</h3>
    <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
      <button id="exportScores">CSV 내보내기</button>
      <input id="fileScores" type="file" accept=".csv" style="display:none">
      <button id="importScores">CSV 불러오기(합치기)</button>
      <button id="clearScores" class="bad">성적 초기화</button>
    </div>
    <div style="max-height:360px; overflow:auto; border-radius:14px">
      <table>
        <thead><tr><th>날짜/시간</th><th>수업코드</th><th>이름</th><th>유형</th><th>문항</th><th>점수</th><th>정답률</th></tr></thead>
        <tbody id="scoreBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/*!
 * Minimal QR generator (alphanumeric ok) – adapted for inline use
 * Reference: qrcode.js (David Shim) simplified – MIT License
 */
(function(global){function QR8bitByte(data){this.mode=1;this.data=data;this.parsed=[];for(var i=0;i<data.length;i++)this.parsed.push(data.charCodeAt(i));this.getLength=function(){return this.parsed.length};this.write=function(buff){for(var i=0;i<this.parsed.length;i++)buff.put(this.parsed[i],8)}}function QRMath(){var EXP_TABLE=new Array(256);var LOG_TABLE=new Array(256);for(var i=0;i<8;i++)EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)EXP_TABLE[i]=EXP_TABLE[i-4]^EXP_TABLE[i-5]^EXP_TABLE[i-6]^EXP_TABLE[i-8];for(i=0;i<256;i++)LOG_TABLE[EXP_TABLE[i]]=i;this.glog=function(n){if(n<1)throw new Error("glog");return LOG_TABLE[n]};this.gexp=function(n){while(n<0)n+=255;while(n>=256)n-=255;return EXP_TABLE[n]}}var QR_MATH=new QRMath();function QRPolynomial(num,shift){if(num.length==undefined)throw new Error(num.length+"/"+shift);var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}QRPolynomial.prototype.get=function(i){return this.num[i]};QRPolynomial.prototype.getLength=function(){return this.num.length};QRPolynomial.prototype.multiply=function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QR_MATH.gexp(QR_MATH.glog(this.get(i))+QR_MATH.glog(e.get(j)));return new QRPolynomial(num,0)};QRPolynomial.prototype.mod=function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=QR_MATH.glog(this.get(0))-QR_MATH.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++)num[i]=this.get(i);for(i=0;i<e.getLength();i++)num[i]^=QR_MATH.gexp(QR_MATH.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)};var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30]],G15:(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1),G18:(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1),G15_MASK:(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1),getBCHTypeInfo:function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0)d^=(QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)));return((data<<10)|d)^QRUtil.G15_MASK},getBCHTypeNumber:function(data){var d=data<<12;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0)d^=(QRUtil.G18<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)));return(data<<12)|d},getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1}return digit},getPatternPosition:function(type){return QRUtil.PATTERN_POSITION_TABLE[type-1]},getMask:function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern.PATTERN000:return (i+j)%2==0;case QRMaskPattern.PATTERN001:return i%2==0;case QRMaskPattern.PATTERN010:return j%3==0;case QRMaskPattern.PATTERN011:return (i+j)%3==0;case QRMaskPattern.PATTERN100:return (Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern.PATTERN101:return (i*j)%2+(i*j)%3==0;case QRMaskPattern.PATTERN110:return ((i*j)%3+(i+j)%2)==0;case QRMaskPattern.PATTERN111:return ((i*j)%3+(i+j)%3)==0;default:throw new Error("bad maskPattern:"+maskPattern)}},getErrorCorrectPolynomial:function(ecLength){var a=new QRPolynomial([1],0);for(var i=0;i<ecLength;i++)a=a.multiply(new QRPolynomial([1,QR_MATH.gexp(i)],0));return a},getLengthInBits:function(mode,type){if(type<10)return 8;else return 16},getLostPoint:function(qr){var moduleCount=qr.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount;col++){var sameCount=0;var dark=qr.isDark(row,col);for(var r=-1;r<=1;r++){if(row+r<0||moduleCount<=row+r)continue;for(var c=-1;c<=1;c++){if(col+c<0||moduleCount<=col+c)continue;if(r==0&&c==0)continue;if(dark==qr.isDark(row+r,col+c))sameCount++}}if(sameCount>5)lostPoint+=3+sameCount-5} }for(row=0;row<moduleCount-1;row++){for(col=0;col<moduleCount-1;col++){var count=0;if(qr.isDark(row,col))count++;if(qr.isDark(row+1,col))count++;if(qr.isDark(row,col+1))count++;if(qr.isDark(row+1,col+1))count++;if(count==0||count==4)lostPoint+=3}}for(row=0;row<moduleCount;row++){for(col=0;col<moduleCount-6;col++){if(qr.isDark(row,col)&&!qr.isDark(row,col+1)&&qr.isDark(row,col+2)&&qr.isDark(row,col+3)&&qr.isDark(row,col+4)&&!qr.isDark(row,col+5)&&qr.isDark(row,col+6))lostPoint+=40}}var darkCount=0;for(col=0;col<moduleCount;col++)for(row=0;row<moduleCount;row++)if(qr.isDark(row,col))darkCount++;var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;lostPoint+=10*ratio;return lostPoint}};function BitBuffer(){this.buffer=[];this.length=0}BitBuffer.prototype.get=function(index){return((this.buffer[Math.floor(index/8)]>>>(7-index%8))&1)==1};BitBuffer.prototype.put=function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>>(length-i-1))&1)==1)};BitBuffer.prototype.putBit=function(bit){this.buffer[Math.floor(this.length/8)]|=(bit?1:0)<<(7-this.length%8);this.length++};function QRCode(type,ecLevel){this.typeNumber=type;this.ecLevel=ecLevel;this.modules=null;this.moduleCount=0;this.dataList=[];this.makeImpl=function(test){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++)this.modules[r][c]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupTimingPattern();this.setupTypeInfo(test,false);if(this.typeNumber>=2)this.setupPositionAdjustPattern();this.mapData(this.createData(this.typeNumber,this.ecLevel), QRMaskPattern.PATTERN000)};this.createData=function(type,ec){var rsBlocks=this.getRSBlocks(type,ec);var buffer=new BitBuffer();for(var i=0;i<this.dataList.length;i++){var data=this.dataList[i];buffer.put(4,4);buffer.put(data.getLength(),QRUtil.getLengthInBits(4,type));data.write(buffer)}var total=0;for(i=0;i<rsBlocks.length;i++)total+=rsBlocks[i].dataCount;while(buffer.length+4<=total*8)buffer.put(0,4);while(buffer.length%8!=0)buffer.putBit(false);var bytes=[];for(i=0;i<buffer.length/8;i++)bytes.push(255&buffer.buffer[i]);return this.createBytes(bytes,rsBlocks)};this.createBytes=function(data,rsBlocks){var offset=0;var dcdata=new Array(rsBlocks.length);var ecdata=new Array(rsBlocks.length);for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount;var ecCount=rsBlocks[r].totalCount-dcCount;dcdata[r]=new Array(dcCount);for(var i=0;i<dcCount;i++)dcdata[r][i]=0xff&data[i+offset];offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var rawPoly=new QRPolynomial(dcdata[r],0);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=new Array(ecCount);for(i=0;i<ecCount;i++){var modIndex=i+modPoly.getLength()-ecCount;ecdata[r][i]=(modIndex>=0)?modPoly.get(modIndex):0}}var totalCodeCount=0;for(r=0;r<rsBlocks.length;r++)totalCodeCount+=rsBlocks[r].totalCount;var data2=new Array(totalCodeCount);var index=0;for(i=0;i<dcdata.length;i++)for(var j=0;j<dcdata[i].length;j++)data2[index++]=dcdata[i][j];for(i=0;i<ecdata.length;i++)for(j=0;j<ecdata[i].length;j++)data2[index++]=ecdata[i][j];return data2};this.addData=function(data){this.dataList.push(new QR8bitByte(data))};this.isDark=function(row,col){return this.modules[row][col]};this.getModuleCount=function(){return this.moduleCount};this.make=function(){this.makeImpl(false)};this.setupPositionProbePattern=function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;this.modules[row+r][col+c]=(r>=0&&r<=6&&(c==0||c==6))||(c>=0&&c<=6&&(r==0||r==6))||(r>=2&&r<=4&&c>=2&&c<=4)}}};this.setupTimingPattern=function(){for(var r=8;r<this.moduleCount-8;r++){if(this.modules[r][6]!=null)continue;this.modules[r][6]=(r%2==0)}for(var c=8;c<this.moduleCount-8;c++){if(this.modules[6][c]!=null)continue;this.modules[6][c]=(c%2==0)}};this.setupPositionAdjustPattern=function(){var pos=QRUtil.getPatternPosition(this.typeNumber);for(var i=0;i<pos.length;i++)for(var j=0;j<pos.length;j++){var row=pos[i];var col=pos[j];if(this.modules[row][col]!=null)continue;for(var r=-2;r<=2;r++)for(var c=-2;c<=2;c++)this.modules[row+r][col+c]=(r==0&&c==0)||(r==-2||r==2||c==-2||c==2)}};this.setupTypeInfo=function(test,mask){var data=(QRErrorCorrectLevel.M<<3)|0;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=((bits>>i)&1)==1;if(i<6)this.modules[i][8]=mod;else if(i<8)this.modules[i+1][8]=mod;else this.modules[this.moduleCount-15+i][8]=mod}for(i=0;i<15;i++){var mod=((bits>>i)&1)==1;if(i<8)this.modules[8][this.moduleCount-i-1]=mod;else this.modules[8][15-i-1]=mod}};this.mapData=function(data,maskPattern){var inc=-1;var row=this.moduleCount-1;var bit=7;var byteIndex=0;for(var col=this.moduleCount-1;col>0;col-=2){if(col==6)col--;for(;;){for(var c=0;c<2;c++){if(this.modules[row][col-c]==null){var dark=false;if(byteIndex<data.length)dark=((data[byteIndex]>>>bit)&1)==1;var mask=QRUtil.getMask(maskPattern,row,col-c);this.modules[row][col-c]=mask?!dark:dark;bit--;if(bit==-1){byteIndex++;bit=7}}}row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break}}}};QRCode.prototype.getRSBlocks=function(type,ec){var list=[{t:1,M:[[19,7]]},{t:2,M:[[34,10]]},{t:3,M:[[55,15]]},{t:4,M:[[80,20]]}];var obj=list[Math.min(type-1,list.length-1)];return obj.M.map(function(p){return {totalCount:p[0],dataCount:p[0]-p[1]}})};QRCode.prototype.renderTo2dContext=function(ctx,size){var mc=this.getModuleCount();var t=size/mc;ctx.clearRect(0,0,size,size);ctx.fillStyle="#fff";ctx.fillRect(0,0,size,size);ctx.fillStyle="#000";for(var r=0;r<mc;r++)for(var c=0;c<mc;c++)if(this.modules[r][c])ctx.fillRect(Math.round(c*t),Math.round(r*t),Math.ceil(t),Math.ceil(t));};function makeQRCanvas(canvas, text){var type=1; if(text.length>40) type=2; if(text.length>80) type=3; if(text.length>120) type=4; var qr=new QRCode(type,QRErrorCorrectLevel.M); qr.addData(text); qr.make(); var size=Math.min(320, Math.max(160, text.length*4)); canvas.width=canvas.height=size; var ctx=canvas.getContext('2d'); qr.renderTo2dContext(ctx,size); } global.makeQRCanvas=makeQRCanvas; })(window);
</script>

<script>
(() => {
  // ---------- Storage Keys ----------
  const KEY_BANK   = 'vocab_bank_v2';
  const KEY_QUIZ   = 'vocab_current_quiz_v2';
  const KEY_SCORES = 'vocab_scores_v2';
  const KEY_WRONGS = 'vocab_wrongs_v2';
  const KEY_CLASS  = 'vocab_class_v2';

  // ---------- State ----------
  let wordBank = loadBank();
  let selectedIds = new Set();
  let currentQuiz = null;
  let justAnswered = false;
  let voices = [];
  let speakOpt = 'off';

  // ---------- Elements (common) ----------
  const statusEl = document.getElementById('status');
  const tabs = document.querySelectorAll('.tab');
  const secTeacher = document.getElementById('teacher');
  const secStudent = document.getElementById('student');
  const secScores  = document.getElementById('scores');

  // Teacher elements
  const bulk = document.getElementById('bulk');
  const parseBulk = document.getElementById('parseBulk');
  const importCsv = document.getElementById('importCsv');
  const fileCsv = document.getElementById('fileCsv');
  const exportCsv = document.getElementById('exportCsv');
  const clearBank = document.getElementById('clearBank');
  const addRow = document.getElementById('addRow');
  const wWord = document.getElementById('wWord');
  const wMean = document.getElementById('wMean');
  const wLevel= document.getElementById('wLevel');
  const wPos  = document.getElementById('wPos');

  const bankBody = document.getElementById('bankBody');
  const toggleAll = document.getElementById('toggleAll');
  const fLevel = document.getElementById('fLevel');
  const fPos = document.getElementById('fPos');
  const filterSelect = document.getElementById('filterSelect');
  const clearSelect = document.getElementById('clearSelect');

  const quizType = document.getElementById('quizType');
  const choiceCount = document.getElementById('choiceCount');
  const questionCount = document.getElementById('questionCount');
  const optSpeak = document.getElementById('optSpeak');
  const classCode = document.getElementById('classCode');
  const shareUrl = document.getElementById('shareUrl');
  const genQR = document.getElementById('genQR');
  const saveQR = document.getElementById('saveQR');
  const qrPanel = document.getElementById('qrPanel');
  const qrCanvas = document.getElementById('qrCanvas');
  const startQuiz = document.getElementById('startQuiz');

  // Student elements
  const stName = document.getElementById('stName');
  const stClass = document.getElementById('stClass');
  const applyStInfo = document.getElementById('applyStInfo');
  const stInfoBadge = document.getElementById('stInfoBadge');

  const quizIntro = document.getElementById('quizIntro');
  const quizArea = document.getElementById('quizArea');
  const qTypeBadge = document.getElementById('qTypeBadge');
  const bar = document.getElementById('bar');
  const qCounter = document.getElementById('qCounter');
  const qTitle = document.getElementById('qTitle');
  const hintRow = document.getElementById('hintRow');
  const speakBtn = document.getElementById('speakBtn');

  const mcWrap = document.getElementById('mcWrap');
  const typingWrap = document.getElementById('typingWrap');
  const typingPrompt = document.getElementById('typingPrompt');
  const typingInput = document.getElementById('typingInput');
  const typingSubmit = document.getElementById('typingSubmit');
  const typingReveal = document.getElementById('typingReveal');
  const typingFeedback = document.getElementById('typingFeedback');
  const lastFeedback = document.getElementById('lastFeedback');
  const nextBtn = document.getElementById('nextBtn');
  const quitBtn = document.getElementById('quitBtn');

  const resultArea = document.getElementById('resultArea');
  const scoreTxt = document.getElementById('scoreTxt');
  const scorePct = document.getElementById('scorePct');
  const breakdown = document.getElementById('breakdown');
  const retryWrong = document.getElementById('retryWrong');
  const reviewWrong = document.getElementById('reviewWrong');
  const restart = document.getElementById('restart');
  const newSet = document.getElementById('newSet');

  // Scores elements
  const scoreBody = document.getElementById('scoreBody');
  const exportScores = document.getElementById('exportScores');
  const importScores = document.getElementById('importScores');
  const fileScores = document.getElementById('fileScores');
  const clearScores = document.getElementById('clearScores');

  // ---------- Utils ----------
  function setStatus(t){ statusEl.textContent = t; }
  function saveBank(){ localStorage.setItem(KEY_BANK, JSON.stringify(wordBank)); }
  function loadBank(){
    const s = localStorage.getItem(KEY_BANK);
    if(s){ try{ return JSON.parse(s); }catch(e){} }
    return [
      {word:'altitude', mean:'고도', level:'B2', pos:'noun'},
      {word:'gravity', mean:'중력', level:'B1', pos:'noun'},
      {word:'ecosystem', mean:'생태계', level:'B1', pos:'noun'},
      {word:'hypothesis', mean:'가설', level:'B2', pos:'noun'},
      {word:'negotiate', mean:'협상하다', level:'B2', pos:'verb'},
      {word:'reliable', mean:'신뢰할 수 있는', level:'B1', pos:'adjective'}
    ];
  }
  function toCsv(rows){
    return rows.map(r=>r.map(v=>{
      const s = String(v).replace(/"/g,'""');
      return /,|\n|"/.test(s) ? `"${s}"` : s;
    }).join(',')).join('\n');
  }
  function download(filename, text){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    URL.revokeObjectURL(url);
  }
  const shuffle = arr => { const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; };

  function renderBank(){
    bankBody.innerHTML = '';
    wordBank.forEach((row, i)=>{
      const tr = document.createElement('tr');
      const checked = selectedIds.has(i);
      tr.innerHTML = `
        <td class="nowrap"><input data-i="${i}" class="sel" type="checkbox" ${checked?'checked':''}></td>
        <td><input data-i="${i}" data-k="word" type="text" value="${row.word||''}" style="width:100%; background:#0d1526; border:1px solid #223054; color:#e6eeff; padding:6px 8px; border-radius:8px"></td>
        <td><input data-i="${i}" data-k="mean" type="text" value="${row.mean||''}" style="width:100%; background:#0d1526; border:1px solid #223054; color:#e6eeff; padding:6px 8px; border-radius:8px"></td>
        <td><input data-i="${i}" data-k="level" type="text" value="${row.level||''}" style="width:100%; background:#0d1526; border:1px solid #223054; color:#e6eeff; padding:6px 8px; border-radius:8px" placeholder="A1~C2"></td>
        <td>
          <select data-i="${i}" data-k="pos" style="width:100%; background:#0d1526; border:1px solid #223054; color:#e6eeff; padding:6px 8px; border-radius:8px">
            ${['','noun','verb','adjective','adverb','pronoun','preposition','conjunction','interjection','phrase','idiom','other'].map(p=>`<option ${p===(row.pos||'')?'selected':''}>${p}</option>`).join('')}
          </select>
        </td>
        <td class="right"><button data-i="${i}" class="del bad">삭제</button></td>`;
      bankBody.appendChild(tr);
    });
    bankBody.querySelectorAll('input.sel').forEach(chk=>{
      chk.addEventListener('change', e=>{
        const i = Number(e.target.getAttribute('data-i'));
        if(e.target.checked) selectedIds.add(i); else selectedIds.delete(i);
      });
    });
    bankBody.querySelectorAll('input[data-k], select[data-k]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.target.getAttribute('data-i'));
        const k = e.target.getAttribute('data-k');
        wordBank[i][k] = e.target.value;
        saveBank();
      });
    });
    bankBody.querySelectorAll('button.del').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const i = Number(e.target.getAttribute('data-i'));
        wordBank.splice(i,1);
        const newSel = new Set(); // reindex
        [...selectedIds].forEach(idx => { if(idx<i) newSel.add(idx); else if(idx>i) newSel.add(idx-1); });
        selectedIds = newSel;
        saveBank(); renderBank();
      });
    });
    toggleAll.checked = wordBank.length>0 && wordBank.every((_,i)=>selectedIds.has(i));
  }

  // ---------- Teacher Actions ----------
  parseBulk.addEventListener('click', ()=>{
    const lines = (bulk.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    let added = 0;
    for(const line of lines){
      const m = line.split(/,(.+)/)[0] ? line.split(',') : [];
      if(m.length>=2){
        const [w,mean,level='',pos=''] = m;
        wordBank.push({word:w.trim(), mean:(mean||'').trim(), level:(level||'').trim(), pos:(pos||'').trim()});
        added++;
      }
    }
    saveBank(); renderBank();
    setStatus(`${added}개 추가됨`);
  });

  importCsv.addEventListener('click', ()=> fileCsv.click());
  fileCsv.addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result;
      const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      let added=0;
      for(const r of rows){
        const m = r.split(',');
        if(m.length>=2){
          const w = (m[0]||'').replace(/^"|"$/g,'').replace(/""/g,'"').trim();
          const mean = (m[1]||'').replace(/^"|"$/g,'').replace(/""/g,'"').trim();
          const level = (m[2]||'').replace(/^"|"$/g,'').replace(/""/g,'"').trim();
          const pos = (m[3]||'').replace(/^"|"$/g,'').replace(/""/g,'"').trim();
          wordBank.push({word:w, mean, level, pos});
          added++;
        }
      }
      saveBank(); renderBank(); setStatus(`CSV에서 ${added}개 추가`);
    };
    reader.readAsText(f, 'utf-8');
    e.target.value = '';
  });

  exportCsv.addEventListener('click', ()=>{
    const rows = [['word','mean','level','pos'], ...wordBank.map(r=>[r.word||'', r.mean||'', r.level||'', r.pos||''])];
    download('wordbank.csv', toCsv(rows));
  });

  clearBank.addEventListener('click', ()=>{
    if(!confirm('단어장을 모두 삭제할까요?')) return;
    wordBank = []; selectedIds.clear(); saveBank(); renderBank();
  });

  addRow.addEventListener('click', ()=>{
    const w = (wWord.value||'').trim(); const m = (wMean.value||'').trim();
    if(!w || !m){ alert('영단어와 뜻을 모두 입력하세요.'); return; }
    wordBank.push({word:w, mean:m, level:(wLevel.value||'').trim(), pos:(wPos.value||'').trim()});
    wWord.value=wMean.value=wLevel.value=''; wPos.value='';
    saveBank(); renderBank(); setStatus('1개 추가됨');
  });

  toggleAll.addEventListener('change', ()=>{
    if(toggleAll.checked){ selectedIds = new Set(wordBank.map((_,i)=>i)); }
    else{ selectedIds.clear(); }
    renderBank();
  });

  filterSelect.addEventListener('click', ()=>{
    const lv = fLevel.value; const pos = fPos.value;
    wordBank.forEach((r,i)=>{
      const okLv = !lv || (r.level||'')===lv;
      const okPos = !pos || (r.pos||'')===pos;
      if(okLv && okPos) selectedIds.add(i);
    });
    renderBank();
  });
  clearSelect.addEventListener('click', ()=>{ selectedIds.clear(); renderBank(); });

  genQR.addEventListener('click', ()=>{
    const cc = (classCode.value||'').trim();
    localStorage.setItem(KEY_CLASS, cc);
    const url = (shareUrl.value||'').trim() || window.location.href;
    const u = new URL(url, window.location.href);
    if(cc) u.searchParams.set('class', cc);
    makeQRCanvas(qrCanvas, u.toString());
    qrPanel.style.display='block';
    setStatus('QR 생성 완료');
  });
  saveQR.addEventListener('click', ()=>{
    if(qrCanvas.width===0){ alert('먼저 QR을 생성하세요.'); return; }
    const link = document.createElement('a');
    link.download = 'class_qr.png';
    link.href = qrCanvas.toDataURL('image/png');
    link.click();
  });

  startQuiz.addEventListener('click', ()=>{
    const selected = [...selectedIds].map(i=>wordBank[i]).filter(r=>r && r.word && r.mean);
    if(selected.length===0){ alert('선택된 단어가 없습니다.'); return; }
    const type = quizType.value;
    const choicesN = Math.max(2, Math.min(6, Number(choiceCount.value||4)));
    const qN = Math.max(1, Math.min(selected.length, Number(questionCount.value||selected.length)));

    speakOpt = optSpeak.value;
    localStorage.setItem(KEY_CLASS, (classCode.value||'').trim());

    const pool = shuffle(selected).slice(0, qN);
    const items = pool.map(src=>{
      if(type.startsWith('mc')){
        const dir = type==='mc_w2m' ? 'w2m' : 'm2w';
        const correct = dir==='w2m' ? src.mean : src.word;
        const wrongPool = selected.filter(r=> (dir==='w2m' ? r.mean : r.word) !== correct);
        const pickFrom = shuffle(wrongPool).slice(0, Math.max(0, choicesN-1)).map(r=> dir==='w2m' ? r.mean : r.word);
        const choices = shuffle([correct, ...pickFrom]).slice(0, choicesN);
        const q = dir==='w2m' ? src.word : src.mean;
        return {q, a:correct, choices, dir, src};
      }else{
        const dir = type==='typing_m2w' ? 'm2w' : 'w2m';
        const q = dir==='m2w' ? src.mean : src.word;
        const a = dir==='m2w' ? src.word : src.mean;
        return {q, a, dir, src};
      }
    });

    currentQuiz = { type, items, idx:0, correct:0, wrong:0, answers:[], speakOpt };
    localStorage.setItem(KEY_QUIZ, JSON.stringify(currentQuiz));
    activateTab('student');
    beginQuiz();
  });

  // ---------- Student ----------
  function applyClassFromURL(){
    const p = new URLSearchParams(window.location.search);
    const c = p.get('class') || localStorage.getItem(KEY_CLASS) || '';
    if(c){ stClass.value = c; classCode.value = c; }
    updateStInfoBadge();
  }

  function updateStInfoBadge(){
    const n = (stName.value||'').trim();
    const c = (stClass.value||'').trim();
    if(n && c){ stInfoBadge.textContent = `이름: ${n} · 수업코드: ${c}`; stInfoBadge.className='badge'; }
    else { stInfoBadge.textContent = '이름/수업코드 미입력'; stInfoBadge.className='badge'; }
  }
  applyStInfo.addEventListener('click', updateStInfoBadge);

  function beginQuiz(){
    const saved = localStorage.getItem(KEY_QUIZ);
    currentQuiz = saved ? JSON.parse(saved) : currentQuiz;
    if(!currentQuiz || !currentQuiz.items || currentQuiz.items.length===0){
      quizIntro.style.display='block'; quizArea.style.display='none'; resultArea.style.display='none';
      setStatus('퀴즈 없음');
      return;
    }
    quizIntro.style.display='none'; resultArea.style.display='none'; quizArea.style.display='block';
    qTypeBadge.textContent = typeLabel(currentQuiz.type);
    currentQuiz.idx = 0; currentQuiz.correct = 0; currentQuiz.wrong = 0; currentQuiz.answers = [];
    renderQuestion();
  }

  function typeLabel(t){
    switch(t){
      case 'mc_w2m': return '객관식 (단어→뜻)';
      case 'mc_m2w': return '객관식 (뜻→단어)';
      case 'typing_m2w': return '타자 (뜻→단어)';
      case 'typing_w2m': return '타자 (단어→뜻)';
      default: return t;
    }
  }

  // Speech
  if('speechSynthesis' in window){
    const updateVoices = ()=>{ voices = window.speechSynthesis.getVoices(); };
    updateVoices(); window.speechSynthesis.onvoiceschanged = updateVoices;
  }
  function speak(text, lang){
    if(!('speechSynthesis' in window)) return alert('이 브라우저는 음성 합성을 지원하지 않습니다.');
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || 'en-US';
    // 영어 우선으로 voice 선택
    const v = voices.find(v=>/^en(-|_)/i.test(v.lang)) || voices[0];
    if(v) u.voice = v;
    window.speechSynthesis.speak(u);
  }

  function renderQuestion(){
    justAnswered = false;
    const i = currentQuiz.idx;
    const N = currentQuiz.items.length;
    const item = currentQuiz.items[i];
    qCounter.textContent = `${i+1}/${N}`;
    bar.style.width = `${(i/N)*100}%`;

    // 힌트 UI 초기화
    speakBtn.style.display = 'none';

    // 힌트 적용
    const src = item.src || {};
    const allowSpeakWord = (currentQuiz.speakOpt==='word' || currentQuiz.speakOpt==='both');
    const allowSpeakMean = (currentQuiz.speakOpt==='mean' || currentQuiz.speakOpt==='both');

    if(currentQuiz.type.startsWith('mc')){
      typingWrap.style.display='none'; mcWrap.style.display='flex';
      qTitle.textContent = item.dir==='w2m' ? `뜻이 무엇일까요?  —  ${item.q}` : `어떤 단어일까요?  —  ${item.q}`;

      // 발음 힌트 버튼
      if(item.dir==='w2m' && allowSpeakWord) { // 질문이 "단어"일 때
        speakBtn.style.display='inline-block';
        speakBtn.onclick = ()=> speak(src.word||item.q, 'en-US');
      }else if(item.dir==='m2w' && allowSpeakMean){
        speakBtn.style.display='inline-block';
        speakBtn.onclick = ()=> speak(src.mean||item.q, 'ko-KR');
      }

      mcWrap.innerHTML = '';
      item.choices.forEach(choice=>{
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = choice;
        btn.addEventListener('click', ()=>{
          if(justAnswered) return;
          justAnswered = true;
          const correct = (choice === item.a);
          btn.classList.add(correct ? 'correct' : 'wrong');
          lastFeedback.textContent = correct ? '정답!' : `오답… 정답: ${item.a}`;
          if(correct) currentQuiz.correct++; else currentQuiz.wrong++;
          currentQuiz.answers.push({q:item.q, a:item.a, given:choice, ok:correct, dir:item.dir, src});
          nextBtn.disabled = false;
        });
        mcWrap.appendChild(btn);
      });
      nextBtn.disabled = true;

    }else{
      mcWrap.style.display='none'; typingWrap.style.display='block';
      qTitle.textContent = item.dir==='m2w' ? `뜻을 보고 단어를 입력하세요` : `단어를 보고 뜻을 입력하세요`;
      typingPrompt.textContent = item.dir==='m2w' ? `뜻: ${item.q}` : `단어: ${item.q}`;
      typingInput.value=''; typingInput.focus();
      typingFeedback.innerHTML=''; lastFeedback.textContent = '';
      nextBtn.disabled = true;

      // 발음 힌트
      if(item.dir==='m2w' && allowSpeakMean){
        speakBtn.style.display='inline-block';
        speakBtn.onclick = ()=> speak(item.q, 'ko-KR');
      }else if(item.dir==='w2m' && allowSpeakWord){
        speakBtn.style.display='inline-block';
        speakBtn.onclick = ()=> speak(item.q, 'en-US');
      }
      
      const submit = ()=>{
        if(justAnswered) return;
        const v = typingInput.value.trim();
        if(!v) return;
        justAnswered = true;
        const ok = eqLoose(v, item.a);
        typingFeedback.innerHTML = ok
          ? `<span class="pill" style="border-color:#1faa6a;background:#0f2d22">정답!</span>`
          : `<span class="pill" style="border-color:#a83d45;background:#2a1618">오답… 정답: ${item.a}</span>`;
        lastFeedback.textContent = '';
        if(ok) currentQuiz.correct++; else currentQuiz.wrong++;
        currentQuiz.answers.push({q:item.q, a:item.a, given:v, ok, dir:item.dir, src});
        nextBtn.disabled = false;
      };

      typingSubmit.onclick = submit;
      typingInput.onkeydown = (e)=>{ if(e.key==='Enter') submit(); };
      typingReveal.onclick = ()=>{ typingFeedback.innerHTML = `<span class="pill">정답: ${item.a}</span>`; };
    }
  }

  function eqLoose(a,b){
    return a.toLowerCase().replace(/\s+/g,' ').trim() === b.toLowerCase().replace(/\s+/g,' ').trim();
  }

  nextBtn.addEventListener('click', ()=>{
    const N = currentQuiz.items.length;
    if(currentQuiz.idx < N-1){
      currentQuiz.idx++;
      renderQuestion();
    }else{
      finishQuiz();
    }
  });
  quitBtn.addEventListener('click', finishQuiz);

  function finishQuiz(){
    quizArea.style.display='none'; resultArea.style.display='block';
    const N = currentQuiz.items.length;
    const s = currentQuiz.correct;
    const pct = Math.round(100*s/N);
    scoreTxt.textContent = `${s}/${N}`;
    scorePct.textContent = `${pct}%`;
    bar.style.width = '100%';

    // 누적 오답 기록 업데이트
    const wrongs = loadWrongs();
    (currentQuiz.answers||[]).forEach(r=>{
      const key = (r.dir==='m2w' ? r.a : r.q) + '|' + (r.dir||'');
      if(!wrongs[key]) wrongs[key] = { word:r.src.word, mean:r.src.mean, dir:r.dir, count:0 };
      if(!r.ok) wrongs[key].count++;
    });
    saveWrongs(wrongs);

    // Breakdown
    const rows = currentQuiz.answers.map((r,idx)=>{
      const tags = [];
      if(r.src.level) tags.push(`레벨:${r.src.level}`);
      if(r.src.pos) tags.push(`품사:${r.src.pos}`);
      const tagStr = tags.length? ` <span class="muted">(${tags.join(', ')})</span>` : '';
      const qtxt = r.dir==='w2m' ? `Q${idx+1} 단어→뜻 [${r.q}]` : `Q${idx+1} 뜻→단어 [${r.q}]`;
      const color = r.ok ? '#a7f3d0' : '#fecaca';
      return `<div style="padding:8px 10px; border:1px solid #223054; border-radius:10px; margin-bottom:6px; background:#0f1728">
        <div class="muted">${qtxt}${tagStr}</div>
        <div>정답: <b style="color:${color}">${r.a}</b> · 내 답: ${r.given ?? '-'}</div>
      </div>`;
    }).join('');
    breakdown.innerHTML = rows || '<div class="muted">답안 기록이 없습니다.</div>';
  }

  // 오답만 재시험
  retryWrong.addEventListener('click', ()=>{
    const wrongItems = currentQuiz.answers.filter(r=>!r.ok).map(r=>r.src);
    if(wrongItems.length===0){ alert('오답이 없습니다!'); return; }
    makeQuizFromPool(wrongItems);
  });

  // 누적 오답 훈련
  reviewWrong.addEventListener('click', ()=>{
    const wrongs = loadWrongs();
    const list = Object.values(wrongs).sort((a,b)=>b.count-a.count).map(x=>({word:x.word, mean:x.mean}));
    if(list.length===0){ alert('누적 오답이 없습니다.'); return; }
    makeQuizFromPool(list.slice(0, Math.min(list.length, 30)));
  });

  // 같은 설정으로 다시
  restart.addEventListener('click', ()=> beginQuiz());

  // 새로운 문제 세트
  newSet.addEventListener('click', () => {
    activateTab('teacher');
    quizIntro.style.display = 'block';
    quizArea.style.display = 'none';
    resultArea.style.display = 'none';
    setStatus('교사 탭에서 새로운 퀴즈를 설정하세요.');
  });

  function makeQuizFromPool(pool){
    const type = currentQuiz.type;
    const choicesN = Math.max(2, Math.min(6, Number(choiceCount.value||4)));
    const qN = Math.min(pool.length, Math.max(1, Number(questionCount.value||pool.length)));
    const selected = shuffle(pool).slice(0, qN);
    const items = selected.map(src=>{
      if(type.startsWith('mc')){
        const dir = type==='mc_w2m' ? 'w2m' : 'm2w';
        const correct = dir==='w2m' ? src.mean : src.word;
        const wrongPool = pool.filter(r=> (dir==='w2m' ? r.mean : r.word) !== correct);
        const pickFrom = shuffle(wrongPool).slice(0, Math.max(0, choicesN-1)).map(r=> dir==='w2m' ? r.mean : r.word);
        const choices = shuffle([correct, ...pickFrom]).slice(0, choicesN);
        const q = dir==='w2m' ? src.word : src.mean;
        return {q, a:correct, choices, dir, src};
      }else{
        const dir = type==='typing_m2w' ? 'm2w' : 'w2m';
        const q = dir==='m2w' ? src.mean : src.word;
        const a = dir==='m2w' ? src.word : src.mean;
        return {q, a, dir, src};
      }
    });
    currentQuiz = { type, items, idx:0, correct:0, wrong:0, answers:[], speakOpt:currentQuiz.speakOpt };
    localStorage.setItem(KEY_QUIZ, JSON.stringify(currentQuiz));
    quizIntro.style.display='none'; resultArea.style.display='none'; quizArea.style.display='block';
    qTypeBadge.textContent = typeLabel(currentQuiz.type);
    renderQuestion();
  }

  // ---------- Scores ----------
  function loadScores(){
    const s = localStorage.getItem(KEY_SCORES);
    if(!s) return [];
    try{ return JSON.parse(s); }catch(e){ return []; }
  }
  function saveScores(list){ localStorage.setItem(KEY_SCORES, JSON.stringify(list)); }
  function renderScores(){
    const list = loadScores();
    scoreBody.innerHTML = list.map(r=>{
      const dt = new Date(r.ts);
      const when = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      return `<tr>
        <td>${when}</td>
        <td>${r.class||''}</td>
        <td>${r.name}</td>
        <td>${r.type}</td>
        <td>${r.count}</td>
        <td>${r.score}</td>
        <td>${r.pct}%</td>
      </tr>`;
    }).join('');
  }
  exportScores.addEventListener('click', ()=>{
    const list = loadScores();
    const rows = [['timestamp','class','name','type','count','score','pct'], ...list.map(r=>[r.ts,r.class||'',r.name,r.type,r.count,r.score,r.pct])];
    download('scores.csv', toCsv(rows));
  });
  importScores.addEventListener('click', ()=> fileScores.click());
  fileScores.addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = reader.result;
      const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const header = rows.shift();
      const idx = (header||'').split(',').reduce((acc,h,i)=>{ acc[h.trim().toLowerCase()]=i; return acc; },{});
      const list = loadScores();
      let added=0;
      for(const r of rows){
        const cols = r.split(',');
        const rec = {
          ts   : (cols[idx['timestamp']]||cols[0]||'').replace(/^"|"$/g,'').replace(/""/g,'"'),
          class: (cols[idx['class']]||'').replace(/^"|"$/g,'').replace(/""/g,'"'),
          name : (cols[idx['name']]||'').replace(/^"|"$/g,'').replace(/""/g,'"'),
          type : (cols[idx['type']]||'').replace(/^"|"$/g,'').replace(/""/g,'"'),
          count: Number((cols[idx['count']]||'0').replace(/"/g,'')),
          score: Number((cols[idx['score']]||'0').replace(/"/g,'')),
          pct  : Number((cols[idx['pct']]||'0').replace(/"/g,''))
        };
        if(rec.ts) { list.push(rec); added++; }
      }
      saveScores(list); renderScores(); alert(`성적 ${added}개 병합`);
    };
    reader.readAsText(f,'utf-8'); e.target.value='';
  });
  clearScores.addEventListener('click', ()=>{
    if(!confirm('성적표를 모두 지울까요?')) return;
    saveScores([]); renderScores();
  });

  // 저장 & 제출(성적 저장은 퀴즈 종료 시 안내)
  function saveResultToScores(){
    const name = (stName.value||'').trim() || '무명';
    const klass = (stClass.value||'').trim() || (localStorage.getItem(KEY_CLASS)||'');
    const N = currentQuiz.items.length;
    const s = currentQuiz.correct;
    const t = new Date();
    const record = {
      ts: t.toISOString(),
      class: klass,
      name,
      type: typeLabel(currentQuiz.type),
      count: N,
      score: s,
      pct: Math.round(100*s/N)
    };
    const list = loadScores(); list.unshift(record); saveScores(list);
  }

  // 학생 탭: 종료 후 자동 저장 안내
  resultArea.addEventListener('click', (e)=>{
    if(e.target.id==='restart' || e.target.id==='retryWrong' || e.target.id==='reviewWrong') return;
    // 클릭 시 저장 유도는 과도할 수 있어 생략
  });

  // ---------- Tabs ----------
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=> activateTab(btn.getAttribute('data-tab')));
  });
  function activateTab(name){
    tabs.forEach(b=>b.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
    secTeacher.style.display = (name==='teacher')?'block':'none';
    secStudent.style.display = (name==='student')?'block':'none';
    secScores.style.display  = (name==='scores')? 'block':'none';
    if(name==='scores') renderScores();
  }

  // ---------- Wrongs store ----------
  function loadWrongs(){
    try{ return JSON.parse(localStorage.getItem(KEY_WRONGS)||'{}'); }catch(e){ return {}; }
  }
  function saveWrongs(w){ localStorage.setItem(KEY_WRONGS, JSON.stringify(w)); }

  // 결과 저장 트리거: 퀴즈가 끝나면 자동 저장(이름/코드 없으면 '무명','(빈코드)')
  document.getElementById('resultArea').addEventListener('click', (e)=>{
    // no-op
  });

  // 종료 시 자동 저장
  const origFinish = finishQuiz;
  finishQuiz = (function(){
    const fn = origFinish;
    return function(){ fn.apply(this, arguments); saveResultToScores(); };
  })();

  // ---------- Init ----------
  renderBank();
  setStatus('단어장 불러옴');
  activateTab('teacher');
  applyClassFromURL();
})();
</script>
</body>
</html>
